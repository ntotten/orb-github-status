version: 2.1

orbs:
  github_status:
    commands:
      post_status:
        parameters:
          state:
            type: string
          description:
            type: string
          context:
            type: string
          when:
            type: string
            default: on_success
        steps:
          - run:
              when: <<parameters.when>>
              name: >
                Set GitHub Status: <<parameters.state>>:
                <<parameters.context>>: <<parameters.description>>
              command: |
                set -euo pipefail
                API=https://api.github.com
                USER=$CIRCLE_PROJECT_USERNAME
                REPO=$CIRCLE_PROJECT_REPONAME
                SHA=$CIRCLE_SHA1
                AUTH=samsalisbury:$GITHUB_ACCESS_TOKEN
                URL=$API/repos/$USER/$REPO/statuses/$SHA
                # The read below will exit with 1 as it hits EOF,
                # so we temporarily disable error checking.
                set +e
                read -r -d '' BODY \<<EOF
                  {
                    "state": "<< parameters.state >>",
                    "target_url": "$CIRCLE_BUILD_URL",
                    "description": "<< parameters.description >>",
                    "context": "ci/print_env"
                  } 
                EOF
                set -euo pipefail
                AUTHLEN=$(echo $AUTH | wc -m | xargs)
                echo "\$ curl -u ?AUTH[$AUTHLEN chars hidden]? -XPOST -d@- $URL"
                echo "< $BODY"
                echo $BODY | curl -u $AUTH -XPOST -d@- $URL
      set_pending:
        parameters:
          description:
            type: string
          context:
            type: string
        steps:
          - post_status:
              when: always
              state: pending
              description: << parameters.description >>
              context: << parameters.context >>
      set_success_or_fail:
        parameters:
          description:
            type: string
          context:
            type: string
        steps:
          - post_status:
              when: on_success
              state: success
              description: << parameters.description >>
              context: << parameters.context >>
          - post_status:
              when: on_fail
              state: failure
              description: << parameters.description >>
              context: << parameters.context >>

jobs:
  print_env:
    docker:
      - image: circleci/buildpack-deps:19.04-curl
    steps:
    - github_status/set_pending:
        description: sleeping 30s
        context: ci/print_env
    - run:
        name: printing env and sleeping 30s
        command: env | grep CIRCLE; echo "Sleeping for 30s"; sleep 30
    - run:
        name: failing for fun
        command: exit 1
    - github_status/set_success_or_fail:
        description: sleeping 30s
        context: ci/print_env

workflows:
  all:
    jobs:
      - print_env
