version: 2.1

commands:
  post_status:
    parameters:
      state:
        type: string
      description:
        type: string
      context:
        type: string
    steps:
      - run:
          command: |
            set -euo pipefail
            API=https://api.github.com
            USER=$CIRCLE_PROJECT_USERNAME
            REPO=$CIRCLE_PROJECT_REPONAME
            SHA=$CIRCLE_SHA1
            AUTH=samsalisbury:$GITHUB_ACCESS_TOKEN
            URL=$API/repos/$USER/$REPO/statuses/$SHA
            # The read below will exit with 1 as it hits EOF,
            # so we temporarily disable error checking.
            set +e
            read -r -d '' BODY \<<EOF
              {
                "state": "<< parameters.state >>",
                "target_url": "$CIRCLE_BUILD_URL",
                "description": "<< parameters.description >>",
                "context": "ci/print_env"
              } 
            EOF
            set -euo pipefail
            AUTHLEN=$(echo $AUTH | wc -m | xargs)
            echo "\$ curl -u ?AUTH[$AUTHLEN chars hidden]? -XPOST -d@- $URL"
            echo "< $BODY"
            echo $BODY | curl -u $AUTH -XPOST -d@- $URL
  set_pending:
    parameters:
      description:
        type: string
      context:
        type: string
    steps:
      - post_status:
          state: pending
          description: << parameters.description >>
          context: << parameters.context >>



jobs:
  print_env:
    docker:
      - image: circleci/buildpack-deps:19.04-curl
    steps:
    - set_pending:
        description: sleeping 30s
        context: ci/print_env
    - run: env | grep CIRCLE; echo "Sleeping for 30s"; sleep 30
    - run:
        name: set success
        when: on_success
        command: export STATE=success DESC=success
    - run:
        name: set failed
        when: on_fail
        command: export STATE=failure DESC=failed
    - run:
        name: set github status success
        when: always
        command: |
          set -euo pipefail
          read -r -d '' BODY \<<EOF
            {
              "state": "$STATE",
              "target_url": "$CIRCLE_BUILD_URL",
              "description": "$DESC",
              "context": "ci/print_env"
            } 
          EOF
          curl -fIu $AUTH -XPOST -d@- $URL < $BODY

workflows:
  all:
    jobs:
      - print_env
